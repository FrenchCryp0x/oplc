name: smoke

on:
  push:
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: '18 */6 * * *'  # every 6 hours

env:
  API: https://r3ddkahili-oplc-api.hf.space
  UI:  https://r3ddkahili-oplc-ui.hf.space

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 7
    steps:
      - name: Show targets
        run: |
          echo "API=$API"
          echo "UI=$UI"

      - name: DNS + warmup
        run: |
          set -euxo pipefail
          API_HOST=$(echo "$API" | sed -E 's#https?://([^/]+).*#\1#')
          UI_HOST=$(echo "$UI" | sed -E 's#https?://([^/]+).*#\1#')
          nslookup "$API_HOST" || true
          nslookup "$UI_HOST" || true
          curl -sSIL "$API/healthz" || true

      - name: Healthz (with retries)
        run: |
          for i in {1..5}; do
            RESP=$(curl -sS -m 10 "$API/healthz" || true)
            echo "attempt $i: $RESP"
            if [ "$RESP" = "ok" ]; then exit 0; fi
            sleep 5
          done
          echo "::error::/healthz failed after 5 attempts"; exit 1

      - name: Range check for known prefix (password)
        run: |
          curl -fsS --retry 3 --retry-all-errors "$API/range/5BAA6" \
            | tee /tmp/range.txt \
            | grep -q '1E4C9B93F3F0682250B6CF8331B7EE68FD8'

      - name: Range padding sanity (>= 800 lines)
        run: |
          LINES=$(wc -l < /tmp/range.txt)
          echo "lines: $LINES"
          test "$LINES" -ge 800

      - name: Verify local SHA-1 (sanity)
        run: |
          python - <<'PY'
          import hashlib
          assert hashlib.sha1(b'password').hexdigest().upper() == '5BAA61E4C9B93F3F0682250B6CF8331B7EE68FD8'
          print('ok')
          PY

      - name: UI reachable (retry + fallbacks)
        run: |
          set -e
          UA="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0 Safari/537.36"
          for i in {1..12}; do
            for path in "/" "/index.html" "/?v=ci"; do
              STATUS=$(curl -sS -o /dev/null -L -A "$UA" -w "%{http_code}" "$UI$path" || true)
              echo "try $i $path -> $STATUS"
              if [ "$STATUS" -ge 200 ] && [ "$STATUS" -lt 400 ]; then
                HTML="$(curl -sS -L -A "$UA" "$UI$path")" || true
                echo "$HTML" | head -n 40
                echo "$HTML" | tr -d '\r' | sed 's/&nbsp;/ /g' \
                  | grep -qiE '<title>.*open password leak check.*</title>|open password leak check' && exit 0
              fi
            done
            sleep 5
          done
          echo "::error::UI not reachable or title not found" ; exit 1
